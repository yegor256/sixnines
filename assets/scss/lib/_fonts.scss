@import 'lib/mixins';

$used-fonts: ();

@mixin import-google-fonts() {
  $fonts: '';

  @each $family, $variations in $used-fonts {
    $family-string: str-replace($family, ' ', '+');
    $variations-string: '';
    @each $variation in $variations {
      $variations-string: "#{$variations-string},#{$variation}";
    }
    $variations-string: str-slice($variations-string, 2);
    $fonts: "#{$fonts}|#{$family-string}:#{$variations-string}";
  }
  $fonts: str-slice($fonts, 2);
  @import url(http://fonts.googleapis.com/css?family=#{$fonts});
}

@function str-replace($string, $search, $replace: '') {
  $index: str-index($string, $search);
  @if $index {
    @return str-slice($string, 1, $index - 1) + $replace + str-replace(str-slice($string, $index + str-length($search)), $search, $replace);
  }
  @return $string;
}

@mixin track-fonts($family, $weight, $style) {

  @if map-has-key($used-fonts, $family) == false {
    $used-fonts: map-merge($used-fonts, ($family: ())) !global;
  }

  $weight-style: if($style == normal, $weight, #{$weight}#{$style});
  $font-map: map-get($used-fonts, $family);
  @if index($font-map, $weight-style) == null {
    $variations: append($font-map, $weight-style);
    $used-fonts: map-merge($used-fonts, ($family: $variations)) !global;
  }
}

@mixin font($family, $weight: 400, $style: normal) {
  @include track-fonts($family, $weight, $style);
  font-family: '#{$family}', Tahoma, Verdana, Arial, Helvetica, sans-serif;
  font-weight: $weight;
}

@each $font in $webfonts {

  $class: nth($font, 1);
  $name: map-get(nth($font, 2), 'family');
  $styles: map-get(nth($font, 2), 'styles');
  @each $style in $styles {
    %font-#{$class}-#{$style} {
      @include font(#{$name}, $style);
    }

    .font-#{$class}-#{$style} {
      @include font(#{$name}, $style);
    }
  }
}

@include import-google-fonts();
